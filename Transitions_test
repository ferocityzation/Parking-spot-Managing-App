import tkinter as tk
from tkinter import ttk
from tkinter import *
from tkinter.messagebox import showinfo
from pathlib import Path
from Registar_ligação import Registar
import yaml

class Window(Tk):
    def __init__(self, frame):
        Tk.__init__(self)
        self.frame = frame(self)
        self.frame.pack()
    
    def switch_frame(self, frame):
        self.frame.destroy()
        self.frame = frame(self)
        self.frame.pack()

class Login(Frame):
    def __init__(self, master, root= tk.Tk()):
        self.root = root
        
            # Give the class instance a function to call when it successfully logs in
        self.root.geometry('300x150')
        self.root.resizable(0, 0)
        self.root.title('Login')
        self.create_menu()
        self.create_buttons()
        self.create_entries()
        self.create_headings()
        
        # configura a grelha
        self.root.columnconfigure(0, weight=1)
        self.root.columnconfigure(1, weight=3)    
        
    def create_headings (self):
        heading = ttk.Label(self.root, text='Bem-vindo', style='Heading.TLabel', font=('Helvetica', 11))
        heading.grid(column=0, row=0, columnspan=2, pady=5, sticky=tk.N)
    
        
    def create_entries(self):
                    
        #acrescenta uma linha vazia para poder puxar conteúdos para baixo
        paddings2 = {'padx': 1, 'pady': 1}
        espaco = ttk.Label(self.root, text="")
        espaco.grid(column=1, row=3, sticky=tk.E, **paddings2)
        espaco2 = ttk.Label(self.root, text="")
        espaco.grid(column=1, row=5, sticky=tk.E, **paddings2)
        
        paddings = {'padx': 5, 'pady': 5}
        entry_font = {'font': ('Helvetica', 10)}
        
        username = tk.StringVar()
        password = tk.StringVar()
        # username
        username_label = ttk.Label(self.root, text="Username:")
        username_label.grid(column=0, row=1, sticky=tk.W, **paddings)
    
        # Never create instance variables outside of the init method
        self.username_entry = ttk.Entry(self.root, textvariable=username, **entry_font)
        self.username_entry.grid(column=1, row=1, sticky=tk.E, **paddings)
    
        # password
        password_label = ttk.Label(self.root, text="Password:")
        password_label.grid(column=0, row=2, sticky=tk.W, **paddings)
    
        # Never create instance variables outside of the init method
        self.password_entry = ttk.Entry(self.root, textvariable=password, show="*", **entry_font)
        self.password_entry.grid(column=1, row=2, sticky=tk.E, **paddings)
    
                
    def create_buttons(self):
        
        #Frame onde os butões ficarão alocados
        # Never create instance variables outside of the init method
        frame_buttons = Frame(self.root)
        frame_buttons.grid(row=4,column=1)
        
        # Frame para editar os butões em conjunto
        # Never create instance variables outside of the init method
        frame_edit_button = Frame(frame_buttons)
        frame_edit_button.grid(row=0,column=0, padx=20,pady=10)
        
        # criação butões 
        # Never create instance variables outside of the init method
        button_login = Button(frame_edit_button,text="Login",  command= self.verificar_login, font=('Helvetica', 9))     #button that runs the login verification
        button_registar = Button(frame_edit_button,text="Registar",  command = lambda: master.switch_frame(Registar), font=('Helvetica', 9))              #button that will take you the registration window
        button_precario = Button(frame_edit_button,text="Preçário",command= self.precario_clicked, font=('Helvetica', 9)) #button that "precario" pop up
        
        # grid dos butões
        # Never create instance variables outside of the init method
        button_login.grid(row=0,column=0, sticky=tk.E)
        button_registar.grid(row=0,column=1, sticky=tk.E)
        button_precario.grid(row=0,column=3, sticky=tk.E)
        
    
        
    def create_menu(self):  #Creates the menu at the top left. Not necessary to have
        # cria o menu "Sair"
        my_menu = Menu(self.root)
        self.root.config(menu = my_menu)
        menu = Menu(my_menu)
        my_menu.add_cascade(label='Sair', menu=menu)                            
        menu.add_command(label='quit', command = self.app_end)
        
    def app_end(self):
        # fecha a app
        self.root.destroy()
    
    def precario_clicked(self):      #Creates the pop up that shows the price of the park. It's not really beautiful, but I'll look into it if I have any time left
        showinfo(title='Preçário', message='O preço deste parque é: \n   1ª hora: 1 euro \n   2ªhora: 0.5 euros \n   3ªhora ou mais: 0.25 euros')
            
    
    def login_success(self, message=""):
        self.app_end()
        self.login_success_callback(message)
        
    def verificar_login(self):
        # Don't forget to call .get to actually get the text
        username1 = self.username_entry.get()
        password1 = self.password_entry.get()
        self.username_entry.delete(0, END)
        self.password_entry.delete(0, END)
    
        # DO NOT rely on the current working directory for this type of thing!
        user_records_file = Path(__file__).parent / "user_records.yaml"
    
        if not user_records_file.exists():                #cria o ficheiro yalm onde ficarão guardados os logins
            with open(user_records_file, "w+") as f:
                # Make an empty file
                pass
    
        # Get all user records from the file
        with open(user_records_file, "r") as f:
            user_records = yaml.load(f, Loader=yaml.FullLoader)
    
        for user_record in user_records:
            print(user_record)
            print(username1)
            print(password1)
    
            if user_record["username"] == username1:
                if user_record["password"] == password1:
                    self.login_success(user_record["parking_pass"])
                    break
    
                else:
                    showinfo(
                        title='Incorrect password!',
                        message='Incorrect password! Try again'
                    )
                    break
    
        else:
            showinfo(title='Erro no login',
                    message='Utlizador não encontrado')
            

class Registar(Frame):
    def __init__(self, master, root= tk.Tk()):
        Frame.__init__(self, master)

        self.root = root
    
        self.root.geometry('280x310')
        self.root.resizable(0, 0)
        self.root.title('Registar')
        self.create_entries_Registar()
        self.create_buttons()
        
        
    
    def create_entries_Registar(self):   
        
        username_registo = tk.StringVar()
        password_registo = tk.StringVar()
        confirmar_pass__registo = tk.StringVar()
        matricula = tk.StringVar()
    
        titulo = ttk.Label(self.root, text="Por favor, digita as suas credenciais")
        titulo.config(background = "#dad2d0")   #dá cor
        titulo.pack()
        espaco = ttk.Label(self.root, text="")
        espaco.pack()
        username_lable = ttk.Label(self.root, text="Username * ")
        username_lable.pack()
        self.username_entry = ttk.Entry(self.root, textvariable=username_registo)
        self.username_entry.pack()
        password_lable = ttk.Label(self.root, text="Password * ")
        password_lable.pack()
        self.password_entry = ttk.Entry(self.root, textvariable=password_registo, show='*')
        self.password_entry.pack()
        confirmar_pass = ttk.Label(self.root, text="Confirme a Password * ")
        confirmar_pass.pack()
        self.confirmar_pass = ttk.Entry(self.root, textvariable=confirmar_pass__registo, show='*')
        self.confirmar_pass.pack()
        matricula = ttk.Label(self.root, text="Digite a sua matrícula * ")
        matricula.pack()
        self.matricula = ttk.Entry(self.root, textvariable=matricula)
        self.matricula.pack()
        espaco = ttk.Label(self.root, text="")
        espaco.pack()
    
    
    def create_buttons(self):
        # criação butões 
        button_regist = Button(self.root,text="Registar",  command= self.registo, font=('Helvetica', 9))
        button_voltar = Button(self.root,text="Voltar",command= None, font=('Helvetica', 9))
        button_precario = Button(self.root,text="Preçário",command= self.precario_clicked, font=('Helvetica', 9))
        button_regist.pack()
        button_precario.pack()
        button_voltar.pack()
        
        
    def app_end(self):
        # fecha a app
        self.root.destroy()
        
    
    def precario_clicked(self):      #Creates the pop up that shows the price of the park. It's not really beautiful, but I'll look into it if I have any time left
        showinfo(title='Preçário', message='O preço deste parque é: \n   1ª hora: 1 euro \n   2ªhora: 0.5 euros \n   3ªhora ou mais: 0.25 euros')
            
    def registo(self):  
        username1 = self.username_entry.get()
        password1 = self.password_entry.get()
        password2 = self.confirmar_pass.get()
        utilizador = "não existe"
        if password1 != password2:
            showinfo(title='Problema com a password',
                    message='As palavras-chaves têm de coincidir')
        else:    #doesn't work I'm trying to see how I can append information into the Yaml files. Also I would like to figure out how to change the information about a particular user
            user_records_file = Path(__file__).parent / "user_records.yaml"
            with open(user_records_file, "r") as f:
                user_records = yaml.load(f, Loader=yaml.FullLoader)
    
            for user_record in user_records:
                if user_record["username"] == username1:
                    showinfo(title='Utilizador já existente',
                            message='O seu nome de utilizador já existe, por favor escolha outro')
                    utilizador = "existe"
                    break
            if utilizador == "não existe":
                f.close()
                user_records_file = Path(__file__).parent / "user_records.yaml"
                with open(user_records_file, "a") as f:
                    user_records = yaml.load(f, Loader=yaml.FullLoader)
                
                user_records.write(f"- parking_pass: inactive\npassword: {password1}\nusername: {username1}")

window = Window(Login)
mainloop()
